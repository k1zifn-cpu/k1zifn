<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Telegram Gift Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            background: #0f0f0f;
            color: #fff;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h2 {
            margin-top: 20px;
        }

        #grid {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(4, 70px);
            grid-gap: 10px;
        }

        .slot {
            width: 70px;
            height: 70px;
            background: #1c1c1c;
            border: 2px solid #2b2b2b;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            user-select: none;
        }

        #buyBtn {
            margin-top: 20px;
            padding: 15px 30px;
            background: #2481cc;
            border: none;
            color: white;
            border-radius: 12px;
            font-size: 18px;
        }

        #money {
            margin-top: 10px;
            font-size: 20px;
        }

        #trash {
            width: 120px;
            height: 120px;
            background: #2b2b2b;
            border-radius: 20px;
            margin-top: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            border: 2px dashed #444;
        }
    </style>
</head>
<body>

<h2>üéÅ Gift Merge Game</h2>

<div id="money">–ë–∞–ª–∞–Ω—Å: ...</div>

<div id="grid"></div>

<button id="buyBtn">–ö—É–ø–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫ (1 –º–æ–Ω–µ—Ç–∞)</button>

<div id="trash">üóëÔ∏è</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const user = tg.initDataUnsafe.user || { id: "guest" };
    const userId = user.id;

    // --- Gifts ---
    const gifts = [
        { emoji: "üß∏", lvl: 1, chance: 10 },
        { emoji: "üíñ", lvl: 2, chance: 9 },
        { emoji: "üåπ", lvl: 3, chance: 7 },
        { emoji: "üéÇ", lvl: 4, chance: 5 },
        { emoji: "üíê", lvl: 5, chance: 4 },
        { emoji: "üçæ", lvl: 6, chance: 3 },
        { emoji: "üöÄ", lvl: 7, chance: 2 },
        { emoji: "üíç", lvl: 8, chance: 1 },
        { emoji: "üíé", lvl: 9, chance: 0.5 },
        { emoji: "üéâ", lvl: 10, chance: 0.2 }
    ];

    // Load game data
    let data = JSON.parse(localStorage.getItem("game_" + userId));

    if (!data) {
        data = {
            money: 100,
            slots: Array(16).fill(null)
        };
        save();
    }

    function save() {
        localStorage.setItem("game_" + userId, JSON.stringify(data));
    }

    function updateUI() {
        document.getElementById("money").innerText = "–ë–∞–ª–∞–Ω—Å: " + data.money;

        const grid = document.getElementById("grid");
        grid.innerHTML = "";

        data.slots.forEach((item, index) => {
            const div = document.createElement("div");
            div.className = "slot";
            div.dataset.index = index;

            if (item) div.textContent = item.emoji;

            div.draggable = item !== null;

            div.addEventListener("dragstart", dragStart);
            div.addEventListener("dragover", dragOver);
            div.addEventListener("drop", drop);

            grid.appendChild(div);
        });
    }

    function getRandomGift() {
        let rand = Math.random() * 100;
        let sum = 0;

        for (let g of gifts) {
            sum += g.chance;
            if (rand <= sum) return g;
        }
        return gifts[0];
    }

    document.getElementById("buyBtn").onclick = () => {
        if (data.money < 1) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!");
        let empty = data.slots.indexOf(null);
        if (empty === -1) return alert("–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤!");

        data.money -= 1;
        data.slots[empty] = getRandomGift();
        save();
        updateUI();
    };

    // Drag & Drop
    let draggedIndex = null;

    function dragStart(e) {
        draggedIndex = e.target.dataset.index;
    }

    function dragOver(e) {
        e.preventDefault();
    }

    function drop(e) {
        let targetIndex = e.target.dataset.index;

        if (draggedIndex === null) return;

        let a = data.slots[draggedIndex];
        let b = data.slots[targetIndex];

        // –ú–µ—Ä–∂ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö
        if (a && b && a.lvl === b.lvl) {
            let next = gifts.find(g => g.lvl === a.lvl + 1);
            data.slots[targetIndex] = next || b;
            data.slots[draggedIndex] = null;
        } 
        // swap
        else {
            data.slots[targetIndex] = a;
            data.slots[draggedIndex] = b;
        }

        save();
        updateUI();
    }

    // Trash delete
    const trash = document.getElementById("trash");

    trash.addEventListener("dragover", e => e.preventDefault());
    trash.addEventListener("drop", () => {
        if (draggedIndex !== null) {
            data.slots[draggedIndex] = null;
            save();
            updateUI();
        }
    });

    updateUI();
</script>

</body>
</html>
